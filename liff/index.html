<!-- liff/index.html -->
<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ç¥¨æ•¸åµæ¸¬ LIFF</title>
  <script src="https://static.line-scdn.net/liff/edge/versions/2.23.1/sdk.js"></script>
  <style>
    body { font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Noto Sans TC",sans-serif; margin:16px; }
    h1 { margin:0 0 6px; font-size:22px; }
    .subtitle { color:#555; margin-bottom:12px; line-height:1.5; }
    .row { display:flex; gap:12px; align-items:center; margin-top:8px; flex-wrap:wrap; }
    .card { border:1px solid #ddd; border-radius:12px; padding:12px; margin:10px 0; background:#fff; }
    .card.disabled { opacity:0.65; }
    .title { font-weight:700; margin-bottom:4px; }
    .hint { color:#666; line-height:1.5; }
    .meta { color:#444; font-size:14px; margin-bottom:4px; }
    button { padding:8px 12px; border-radius:10px; border:1px solid #ccc; cursor:pointer; background:#fafafa; }
    button:disabled { opacity:0.6; cursor:not-allowed; }
    button.danger { background:#ffeceb; border-color:#ff867c; color:#d84315; }
    input { padding:6px 8px; border-radius:8px; border:1px solid #ccc; width:90px; }
    a { color:#007aff; text-decoration:none; }
    a:hover { text-decoration:underline; }
    #out { margin:8px 0; color:#999; }
    .hidden { display:none !important; }
  </style>
</head>
<body>
  <h1 id="pageTitle">ç¥¨æ•¸åµæ¸¬ LIFF</h1>
  <div id="modeHint" class="subtitle"></div>
  <div class="row" id="controls">
    <span id="secWrap">ç›£çœ‹ç§’æ•¸ï¼š<input id="sec" type="number" min="15" step="1" value="30" /></span>
    <button id="reload">é‡æ–°æ•´ç†æ¸…å–®</button>
  </div>
  <div id="out" class="hint">åˆå§‹åŒ–ä¸­â€¦</div>
  <div id="list"></div>

<script>
/** ====== ä½ çš„è¨­å®šï¼ˆä½¿ç”¨å®Œæ•´ç¶²åŸŸï¼‰ ====== */
var LIFF_ID = "2008066018-EMmpzmKo";  // ä½ çš„ LIFF ID
var API_BASE = "https://ticketsearch-419460755270.asia-east1.run.app/liff"; // å¾Œç«¯ç¶²å€ï¼ˆä¸å«å°¾ç«¯æ–œç·šï¼‰
var MIN_SEC = 15;
/** ===================================== */

var API_ACTIVITIES = API_BASE + "/activities";
var API_TASKS = API_BASE + "/tasks";
var API_UNWATCH = API_BASE + "/unwatch";

var params = new URLSearchParams(window.location.search);

function parseStateParams(raw){
  if (!raw) return null;
  try {
    var decoded = decodeURIComponent(raw);
    if (!decoded) return null;
    if (decoded.charAt(0) === '#'){
      return parseHashParams(decoded);
    }
    if (decoded.indexOf("http://") === 0 || decoded.indexOf("https://") === 0){
      var url = new URL(decoded);
      if (url.search && url.search.length > 1){
        var qp = new URLSearchParams(url.search.slice(1));
        if (!qp.has("mode") && url.hash){
          var hp = parseHashParams(url.hash);
          if (hp && hp.has("mode")) qp.set("mode", hp.get("mode"));
        }
        return qp;
      }
      if (url.hash){
        return parseHashParams(url.hash);
      }
      return null;
    }
    var hashIndex = decoded.indexOf("#");
    var hashPart = hashIndex >= 0 ? decoded.slice(hashIndex) : "";
    var query = hashIndex >= 0 ? decoded.slice(0, hashIndex) : decoded;
    if (query.indexOf("?") >= 0){
      query = query.split("?").pop();
    }
    query = query.trim();
    if (!query){
      return hashPart ? parseHashParams(hashPart) : null;
    }
    if (query.indexOf("=") === -1){
      var p = new URLSearchParams();
      var modeText = query.replace(/^\/+/, "");
      if (modeText){
        p.set("mode", modeText);
        return p;
      }
      if (hashPart){
        return parseHashParams(hashPart);
      }
      return null;
    }
    var params = new URLSearchParams(query);
    if (hashPart){
      var extra = parseHashParams(hashPart);
      if (extra && extra.has("mode") && !params.has("mode")){
        params.set("mode", extra.get("mode"));
      }
    }
    return params;
  } catch (e){
    console.error(e);
    return null;
  }
}

function parseHashParams(hash){
  if (!hash) return null;
  var text = String(hash || "").replace(/^#/, "").trim();
  if (!text) return null;
  if (text.indexOf("=") === -1){
    var p = new URLSearchParams();
    p.set("mode", text);
    return p;
  }
  try {
    return new URLSearchParams(text);
  } catch (e){
    console.error(e);
    return null;
  }
}

var stateParams = parseStateParams(params.get("liff.state"));
var hashParams = parseHashParams(window.location.hash);

function mergedParam(key){
  if (params.has(key) && params.get(key) !== null && params.get(key) !== ""){
    return params.get(key);
  }
  if (stateParams && stateParams.has(key)){
    return stateParams.get(key);
  }
  if (hashParams && hashParams.has(key)){
    return hashParams.get(key);
  }
  return null;
}
var MODE_CONFIG = {
  "watch": {
    pageTitle: "é–‹å§‹ç›£çœ‹",
    description: "é¸æ“‡è¦è¿½è¹¤çš„æ´»å‹•ä¸¦å‚³é€ /watch æŒ‡ä»¤ï¼Œç³»çµ±æœƒä¾æŒ‡å®šç§’æ•¸è‡ªå‹•ç›£æ¸¬å‰©é¤˜ç¥¨æ•¸ã€‚",
    reloadLabel: "é‡æ–°æ•´ç†æ¸…å–®",
    buttonLabel: "âœ… ç›£çœ‹",
    busyLabel: "é€å‡ºä¸­â€¦",
    successAlert: "å·²é€å‡ºç›£çœ‹æŒ‡ä»¤åˆ°èŠå¤©å®¤ï¼",
    needsActs: true,
    needsSec: true,
    emptyHint: "ç›®å‰æŠ“ä¸åˆ°æ´»å‹•æ¸…å–®ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚",
    apiError: "è«‹ç¢ºèªå¾Œç«¯ /liff/activities æ˜¯å¦å¯ç”¨ï¼Œä¸¦é–‹å•Ÿ CORSã€‚",
    commandBuilder: function(url){
      var sec = ensureSec(document.getElementById("sec").value);
      return "/watch " + url + " " + sec;
    },
    onOutsideLine: function(url){
      alert("æç¤ºï¼šç›®å‰ä¸æ˜¯å¾ LINE å…§é–‹å•Ÿï¼Œå°‡åƒ…é–‹å•Ÿæ´»å‹•é é¢ã€‚");
      window.open(url, "_blank");
    },
    onSuccess: function(url){
      try {
        liff.openWindow({ url: url, external: false });
      } catch (e) {}
    }
  },
  "check": {
    pageTitle: "å¿«é€ŸæŸ¥çœ‹",
    description: "é»æ“Šæ´»å‹•å³å¯å¿«é€Ÿå‚³é€ /check æŒ‡ä»¤ï¼Œç«‹å³è¿”å›èŠå¤©å®¤æŸ¥çœ‹æœ€æ–°ç¥¨æ•¸ã€‚",
    reloadLabel: "é‡æ–°æ•´ç†æ¸…å–®",
    buttonLabel: "ğŸ‘€ å¿«é€ŸæŸ¥çœ‹",
    busyLabel: "æŸ¥è©¢ä¸­â€¦",
    successAlert: "å·²é€å‡ºæŸ¥è©¢æŒ‡ä»¤åˆ°èŠå¤©å®¤ï¼",
    needsActs: true,
    needsSec: false,
    emptyHint: "ç›®å‰æŠ“ä¸åˆ°æ´»å‹•æ¸…å–®ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚",
    apiError: "è«‹ç¢ºèªå¾Œç«¯ /liff/activities æ˜¯å¦å¯ç”¨ã€‚",
    commandBuilder: function(url){ return "/check " + url; },
    onOutsideLine: function(){
      alert("æç¤ºï¼šè«‹å¾ LINE å…§é–‹å•Ÿæ­¤é ï¼Œä»¥ä¾¿æŠŠæŸ¥è©¢çµæœé€å›èŠå¤©å®¤ã€‚");
    },
    onSuccess: function(){
      setTimeout(function(){
        try { liff.closeWindow(); } catch (e) {}
      }, 400);
    }
  },
  "list": {
    pageTitle: "æŸ¥çœ‹æ¸…å–®",
    description: "é¡¯ç¤ºç›®å‰çš„ç›£çœ‹ä»»å‹™èˆ‡æœ€è¿‘è®€å–ç‹€æ…‹ã€‚",
    reloadLabel: "é‡æ–°æ•´ç†ä»»å‹™",
    needsTasks: true,
    allowStop: false,
    defaultStatus: "all",
    emptyTitle: "æ²’æœ‰ç›£çœ‹ä»»å‹™",
    emptyHint: "ç›®å‰æ²’æœ‰ä»»ä½•ç›£çœ‹ä»»å‹™ã€‚",
    apiError: "è«‹ç¢ºèªå¾Œç«¯ /liff/tasks æ˜¯å¦å¯ç”¨ã€‚"
  },
  "stop": {
    pageTitle: "åœæ­¢ç›£çœ‹",
    description: "æŒ‘é¸è¦åœç”¨çš„ä»»å‹™ï¼Œç³»çµ±æœƒç«‹å³åœæ­¢ç›£çœ‹ã€‚",
    reloadLabel: "é‡æ–°æ•´ç†ä»»å‹™",
    needsTasks: true,
    allowStop: true,
    defaultStatus: "on",
    emptyTitle: "æ²’æœ‰å•Ÿç”¨ä¸­çš„ä»»å‹™",
    emptyHint: "ç›®å‰æ²’æœ‰å•Ÿç”¨ä¸­çš„ç›£çœ‹ä»»å‹™ã€‚",
    apiError: "è«‹ç¢ºèªå¾Œç«¯ /liff/tasks æ˜¯å¦å¯ç”¨ã€‚",
    stopButtonLabel: "ğŸ›‘ åœæ­¢ç›£çœ‹",
    stopConfirmMessage: "ç¢ºå®šè¦åœæ­¢ç›£çœ‹ä»»å‹™ {id} å—ï¼Ÿ",
    stopBusyLabel: "é€å‡ºä¸­â€¦",
    stopSuccessAlert: "å·²é€å‡ºåœæ­¢ç›£çœ‹æŒ‡ä»¤ï¼",
    stopFallbackAlert: "å·²åœç”¨ä»»å‹™ï¼Œä½†æœªèƒ½å‚³é€èŠå¤©è¨Šæ¯ï¼Œè«‹ç¢ºèª LIFF æ¬Šé™ã€‚",
    stopSendError: "ç„¡æ³•é€å‡ºåœæ­¢æŒ‡ä»¤",
    stopErrorAlert: "åœç”¨å¤±æ•—",
    stopOutsideHint: "è«‹å¾ LINE å°è©±ä¸­é–‹å•Ÿæ­¤åŠŸèƒ½ï¼Œæ‰èƒ½åœæ­¢ç›£çœ‹ã€‚",
    stopCommandBuilder: function(task){
      return (task && task.id) ? ("/unwatch " + task.id) : "";
    },
    stopUseApiFallback: true
  }
};

function normalizeMode(value){
  if (value === undefined || value === null) return null;
  var mode = String(value).trim().toLowerCase();
  if (!mode) return null;
  var alias = {
    "start": "watch",
    "monitor": "watch",
    "watch": "watch",
    "quick": "check",
    "quickcheck": "check",
    "quick-view": "check",
    "quickview": "check",
    "fast": "check",
    "check": "check",
    "stop": "stop",
    "stopwatch": "stop",
    "unwatch": "stop",
    "cancel": "stop",
    "cancelwatch": "stop",
    "list": "list",
    "lists": "list",
    "task": "list",
    "tasks": "list",
    "tasklist": "list",
    "view": "list"
  };
  if (alias[mode]){
    mode = alias[mode];
  }
  return MODE_CONFIG[mode] ? mode : null;
}

function detectMode(){
  var mode = normalizeMode(mergedParam("mode"));
  if (!mode){
    var altKeys = ["feature", "action", "view", "tab"];
    for (var i = 0; i < altKeys.length; i++){
      mode = normalizeMode(mergedParam(altKeys[i]));
      if (mode) break;
    }
  }
  if (!mode){
    try {
      var path = window.location && window.location.pathname ? window.location.pathname : "";
      if (path){
        var parts = path.split("/").filter(function(x){ return !!x; });
        if (parts.length >= 2){
          var guess = parts[parts.length - 1].toLowerCase();
          var normalized = normalizeMode(guess);
          if (normalized) mode = normalized;
        }
      }
    } catch (e){
      console.error(e);
    }
  }
  if (!mode || !MODE_CONFIG[mode]) mode = "watch";
  return mode;
}

var MODE = detectMode();
var CONFIG = MODE_CONFIG[MODE];
CONFIG.needsActs = !!CONFIG.needsActs;
CONFIG.needsTasks = !!CONFIG.needsTasks;
CONFIG.needsSec = !!CONFIG.needsSec;
CONFIG.allowStop = !!CONFIG.allowStop;
CONFIG.stopUseApiFallback = CONFIG.stopUseApiFallback !== false;
CONFIG.stopCommandBuilder = (typeof CONFIG.stopCommandBuilder === "function") ? CONFIG.stopCommandBuilder : null;

var TASK_STATUS = normalizeStatus(mergedParam("status") || CONFIG.defaultStatus || "on");
var reloadFn = function(){};
var chatId = null;

var titleEl = document.getElementById("pageTitle");
var hintEl = document.getElementById("modeHint");
var secWrap = document.getElementById("secWrap");
var reloadBtn = document.getElementById("reload");
var outEl = document.getElementById("out");

if (titleEl) titleEl.textContent = CONFIG.pageTitle + "";
if (hintEl) hintEl.textContent = CONFIG.description || "";
if (reloadBtn) reloadBtn.textContent = CONFIG.reloadLabel || "é‡æ–°æ•´ç†";
if (!CONFIG.needsSec && secWrap) secWrap.classList.add("hidden");
document.title = CONFIG.pageTitle + " - ç¥¨æ•¸åµæ¸¬ LIFF";

document.getElementById("reload").onclick = function(){
  if (typeof reloadFn === "function") reloadFn();
};

function ensureSec(v){
  var n = parseInt(v, 10);
  if (isNaN(n) || n < MIN_SEC) n = MIN_SEC;
  return n;
}

function normalizeStatus(v){
  var s = String(v || "").toLowerCase();
  if (s === "off") return "off";
  if (s === "all") return "all";
  return "on";
}

function buildActivityUrl(){
  var qs = [];
  var limit = mergedParam("limit");
  if (limit) qs.push("limit=" + encodeURIComponent(limit));
  var keyword = mergedParam("q");
  if (keyword) qs.push("q=" + encodeURIComponent(keyword));
  var onlyConcert = mergedParam("onlyConcert");
  if (onlyConcert) qs.push("onlyConcert=" + encodeURIComponent(onlyConcert));
  return qs.length ? (API_ACTIVITIES + "?" + qs.join("&")) : API_ACTIVITIES;
}

var ACTIVITY_URL = buildActivityUrl();

function fetchActs(){
  return fetch(ACTIVITY_URL, { credentials: "include", mode: "cors" }).then(function(res){
    if (!res.ok) throw new Error("HTTP " + res.status);
    return res.json();
  });
}

function fetchTasks(){
  if (!chatId) return Promise.reject(new Error("missing chatId"));
  var url = API_TASKS + "?chatId=" + encodeURIComponent(chatId) + "&status=" + encodeURIComponent(TASK_STATUS);
  return fetch(url, { credentials: "include", mode: "cors" }).then(function(res){
    return res.json().catch(function(){ return {}; }).then(function(body){
      if (!res.ok || !body.ok){
        var msg = (body && body.error) ? body.error : ("HTTP " + res.status);
        throw new Error(msg);
      }
      return body;
    });
  });
}

function sendUnwatch(taskId){
  if (!chatId) return Promise.reject(new Error("missing chatId"));
  return fetch(API_UNWATCH, {
    method: "POST",
    credentials: "include",
    mode: "cors",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ chatId: chatId, taskId: taskId })
  }).then(function(res){
    return res.json().catch(function(){ return {}; }).then(function(body){
      if (!res.ok || !body.ok){
        var msg = (body && body.error) ? body.error : ("HTTP " + res.status);
        throw new Error(msg);
      }
      return body;
    });
  });
}

function el(tag, cls, html){
  var d = document.createElement(tag);
  if (cls) d.className = cls;
  if (html != null) d.innerHTML = html;
  return d;
}

function showListMessage(title, desc){
  var elList = document.getElementById("list");
  elList.innerHTML = "";
  var card = el("div", "card", "");
  card.appendChild(el("div", "title", title || "æç¤º"));
  if (desc) card.appendChild(el("div", "hint", desc));
  elList.appendChild(card);
}

function showFetchError(detail){
  var desc = CONFIG.apiError || "è«‹ç¨å¾Œå†è©¦ã€‚";
  if (detail) desc += " (" + detail + ")";
  showListMessage("è®€å–è³‡æ–™å¤±æ•—", desc);
}

function pad2(n){
  return String(n).padStart(2, "0");
}

function formatTime(iso){
  if (!iso) return "";
  var d = new Date(iso);
  if (isNaN(d.getTime())) return "";
  var y = d.getFullYear();
  var m = pad2(d.getMonth() + 1);
  var day = pad2(d.getDate());
  var hh = pad2(d.getHours());
  var mm = pad2(d.getMinutes());
  return y + "/" + m + "/" + day + " " + hh + ":" + mm;
}

function renderActivities(acts){
  var elList = document.getElementById("list");
  elList.innerHTML = "";

  if (!Array.isArray(acts) || acts.length === 0){
    showListMessage("ç›®å‰æŠ“ä¸åˆ°æ´»å‹•æ¸…å–®", CONFIG.emptyHint || "è«‹ç¨å¾Œå†è©¦ã€‚");
    return;
  }

  acts.forEach(function(it, i){
    var title = it.title || ("æ´»å‹• " + (i + 1));
    var url = it.url || "";

    var card = el("div", "card", "");
    card.appendChild(el("div", "title", pad2(i + 1) + ". " + title));

    if (it.date || it.place){
      var info = [];
      if (it.place) info.push("ğŸ“ " + it.place);
      if (it.date) info.push("ğŸ“… " + it.date);
      if (info.length) card.appendChild(el("div", "hint", info.join("ï½œ")));
    }

    var row = el("div", "row", "");
    var link = el("a", null, "æ´»å‹•é é¢");
    if (url){
      link.href = url;
      link.target = "_blank";
    }else{
      link.className = "hint";
      link.href = "javascript:void(0)";
      link.innerHTML = "ï¼ˆç„¡æœ‰æ•ˆé€£çµï¼‰";
    }
    row.appendChild(link);

    if (CONFIG.buttonLabel){
      var btn = el("button", null, CONFIG.buttonLabel);
      btn.onclick = function(){ handleActivityAction(url, btn); };
      row.appendChild(btn);
    }

    card.appendChild(row);
    elList.appendChild(card);
  });
}

function renderTasks(tasks){
  var elList = document.getElementById("list");
  elList.innerHTML = "";

  if (!Array.isArray(tasks) || tasks.length === 0){
    showListMessage(CONFIG.emptyTitle || "æ²’æœ‰ç›£çœ‹ä»»å‹™", CONFIG.emptyHint || "");
    return;
  }

  tasks.forEach(function(task, idx){
    var classes = "card";
    if (!task.enabled) classes += " disabled";
    var card = el("div", classes, "");
    var displayTitle = task.title || ("ä»»å‹™ " + (task.id || pad2(idx + 1)));
    card.appendChild(el("div", "title", pad2(idx + 1) + ". " + displayTitle));

    var statusText = task.enabled ? "å•Ÿç”¨ä¸­" : "å·²åœç”¨";
    var metaParts = ["ä»»å‹™ä»£ç¢¼ï¼š" + (task.id || "æœªçŸ¥"), "ç‹€æ…‹ï¼š" + statusText];
    if (task.period) metaParts.push("é »ç‡ï¼š" + task.period + " ç§’");
    card.appendChild(el("div", "meta", metaParts.join("ï½œ")));

    var infoParts = [];
    if (task.place) infoParts.push("ğŸ“ " + task.place);
    if (task.date) infoParts.push("ğŸ“… " + task.date);
    if (infoParts.length) card.appendChild(el("div", "hint", infoParts.join("ï½œ")));

    var row = el("div", "row", "");
    var link = el("a", null, "æ´»å‹•é é¢");
    if (task.url){
      link.href = task.url;
      link.target = "_blank";
    }else{
      link.className = "hint";
      link.href = "javascript:void(0)";
      link.innerHTML = "ï¼ˆç„¡æœ‰æ•ˆé€£çµï¼‰";
    }
    row.appendChild(link);
    card.appendChild(row);

    var statusParts = [];
    if (typeof task.lastTotal === "number" && task.lastTotal > 0){
      statusParts.push("æœ€è¿‘è®€å–ï¼š" + task.lastTotal + " å¼µ");
    }else if (task.lastOk){
      statusParts.push("æœ€è¿‘è®€å–ï¼šæœ‰ç¥¨ä½†æœªå…¬å¸ƒæ•¸é‡");
    }
    if (task.updatedAt){
      statusParts.push("æ›´æ–°ï¼š" + formatTime(task.updatedAt));
    }
    if (statusParts.length){
      card.appendChild(el("div", "hint", statusParts.join("ï½œ")));
    }

    if (CONFIG.allowStop && task.enabled){
      var btnRow = el("div", "row", "");
      var btnLabel = CONFIG.stopButtonLabel || "ğŸ›‘ åœæ­¢ç›£çœ‹";
      var btn = el("button", "danger", btnLabel);
      btn.onclick = function(){ handleStopTask(task, btn); };
      btnRow.appendChild(btn);
      card.appendChild(btnRow);
    }

    elList.appendChild(card);
  });
}

function handleActivityAction(url, btn){
  if (!url){
    alert("æ­¤æ´»å‹•æ²’æœ‰å¯ç”¨çš„ URLï¼Œç„¡æ³•æ“ä½œã€‚");
    return;
  }
  if (!CONFIG.commandBuilder){
    alert("æ­¤æ¨¡å¼æœªæä¾›æŒ‡ä»¤åŠŸèƒ½ã€‚");
    return;
  }
  var text = CONFIG.commandBuilder(url);
  if (!text){
    alert("ç„¡æ³•å»ºç«‹æŒ‡ä»¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
    return;
  }

  var original = btn.textContent;
  btn.disabled = true;
  btn.textContent = CONFIG.busyLabel || "è™•ç†ä¸­â€¦";

  var finish = function(){
    btn.disabled = false;
    btn.textContent = original;
  };

  if (!liff.isInClient()){
    if (typeof CONFIG.onOutsideLine === "function"){
      CONFIG.onOutsideLine(url);
    } else {
      alert("è«‹å¾ LINE å…§é–‹å•Ÿæ­¤é ï¼Œä»¥ä¾¿é€å‡ºæŒ‡ä»¤ã€‚");
    }
    finish();
    return;
  }

  liff.sendMessages([{ type: "text", text: text }]).then(function(){
    if (CONFIG.successAlert) alert(CONFIG.successAlert);
    if (typeof CONFIG.onSuccess === "function") CONFIG.onSuccess(url);
  }).catch(function(e){
    console.error(e);
    var detail = (e && e.message) ? e.message : e;
    var msg = "é€è¨Šæ¯æˆ–é–‹å•Ÿé é¢å¤±æ•—ï¼š" + detail;
    if (detail && String(detail).toLowerCase().indexOf("permission is not in liff app scope") !== -1) {
      msg += "\n\nè«‹å‰å¾€ LINE Developers > LIFF è¨­å®šåŠ å…¥ chat_message.write æ¬Šé™ï¼Œä¸¦é‡æ–°ç™¼ä½ˆ LIFF / rich menuã€‚";
    }
    alert(msg);
  }).finally(finish);
}

function handleStopTask(task, btn){
  if (!task) return;
  var taskId = task.id || "";
  if (!taskId){
    alert("æ‰¾ä¸åˆ°ä»»å‹™ä»£ç¢¼ï¼Œç„¡æ³•åœç”¨ã€‚");
    return;
  }

  var confirmMsg = CONFIG.stopConfirmMessage || "";
  if (confirmMsg){
    confirmMsg = confirmMsg.replace(/\{id\}/g, taskId);
    if (!confirm(confirmMsg)) return;
  }

  var original = btn.textContent;
  btn.disabled = true;
  btn.textContent = CONFIG.stopBusyLabel || "è™•ç†ä¸­â€¦";

  var done = function(){
    btn.disabled = false;
    btn.textContent = original;
  };

  var reloadLater = function(delayMs){
    var wait = typeof delayMs === "number" ? delayMs : 600;
    setTimeout(function(){
      try { loadTasks(); } catch (e) { console.error(e); }
    }, wait);
  };

  var notifySuccess = function(fromFallback){
    if (typeof CONFIG.onStopSuccess === "function"){
      try { CONFIG.onStopSuccess(task, !!fromFallback); }
      catch (e){ console.error(e); }
    } else {
      reloadLater();
    }
  };

  var command = null;
  if (CONFIG.stopCommandBuilder){
    try { command = CONFIG.stopCommandBuilder(task); }
    catch (e){ console.error(e); command = null; }
  }
  if (!command && taskId){
    command = "/unwatch " + taskId;
  }
  if (command){
    command = String(command).trim();
    if (!command) command = null;
  }

  var useFallback = CONFIG.stopUseApiFallback !== false;

  var fallback = function(){
    if (!useFallback){
      done();
      return;
    }
    sendUnwatch(taskId).then(function(){
      if (CONFIG.stopFallbackAlert){
        alert(CONFIG.stopFallbackAlert.replace(/\{id\}/g, taskId));
      }
      notifySuccess(true);
    }).catch(function(err){
      console.error(err);
      var detail = (err && err.message) ? err.message : err;
      var prefix = CONFIG.stopErrorAlert || "åœç”¨å¤±æ•—";
      alert(prefix + (detail ? "ï¼š" + detail : ""));
    }).finally(done);
  };

  if (!command){
    fallback();
    return;
  }

  if (!liff.isInClient()){
    if (CONFIG.stopOutsideHint){
      alert(CONFIG.stopOutsideHint);
    }
    fallback();
    return;
  }

  liff.sendMessages([{ type: "text", text: command }]).then(function(){
    if (CONFIG.stopSuccessAlert){
      alert(CONFIG.stopSuccessAlert.replace(/\{id\}/g, taskId));
    }
    notifySuccess(false);
    done();
  }).catch(function(err){
    console.error(err);
    var detail = (err && err.message) ? err.message : err;
    var msg = CONFIG.stopSendError || "ç„¡æ³•é€å‡ºåœæ­¢æŒ‡ä»¤";
    if (detail){
      msg += "ï¼š" + detail;
    }
    if (detail && String(detail).toLowerCase().indexOf("permission is not in liff app scope") !== -1){
      msg += "\n\nè«‹å‰å¾€ LINE Developers > LIFF è¨­å®šåŠ å…¥ chat_message.write æ¬Šé™ï¼Œä¸¦é‡æ–°ç™¼ä½ˆ LIFF / rich menuã€‚";
    }
    alert(msg);
    fallback();
  });
}

function setOut(text){
  if (outEl) outEl.textContent = text || "";
}

function resolveChatId(ctx, profile){
  if (!ctx) return (profile && profile.userId) || null;
  switch (ctx.type) {
    case "utou":
    case "user":
    case "none":
      return (profile && profile.userId) || ctx.userId || null;
    case "group":
      return ctx.groupId || null;
    case "room":
      return ctx.roomId || null;
    default:
      return (profile && profile.userId) || null;
  }
}

function loadActivities(){
  setOut("è®€å–æ´»å‹•æ¸…å–®ä¸­â€¦");
  fetchActs().then(function(acts){
    setOut("");
    renderActivities(acts);
  }).catch(function(err){
    console.error(err);
    setOut("");
    showFetchError(err && err.message);
  });
}

function loadTasks(){
  if (!chatId){
    setOut("è«‹é‡æ–°æ•´ç†æˆ–å›åˆ° LINE å°è©±å†è©¦ã€‚");
    return;
  }
  setOut("è®€å–ä»»å‹™æ¸…å–®ä¸­â€¦");
  fetchTasks().then(function(data){
    setOut("");
    renderTasks(data.tasks || []);
  }).catch(function(err){
    console.error(err);
    setOut("");
    showFetchError(err && err.message);
  });
}

function boot(){
  setOut("LIFF åˆå§‹åŒ–ä¸­â€¦");
  liff.init({ liffId: LIFF_ID }).then(function(){
    if (CONFIG.needsTasks){
      if (!liff.isInClient()){
        setOut("è«‹å¾ LINE å°è©±ä¸­é–‹å•Ÿæ­¤åŠŸèƒ½ï¼Œä»¥ä¾¿è®€å–ä»»å‹™æ¸…å–®ã€‚");
        showListMessage("éœ€è¦å¾ LINE é–‹å•Ÿ", "è«‹å›åˆ°èˆ‡æ©Ÿå™¨äººçš„èŠå¤©è¦–çª—å¾Œå†é»é¸æ­¤åŠŸèƒ½ã€‚");
        return;
      }
      var ctx = null;
      try { ctx = liff.getContext(); } catch (e) { ctx = null; }
      liff.getProfile().then(function(profile){
        chatId = resolveChatId(ctx, profile);
        if (!chatId){
          setOut("æ‰¾ä¸åˆ°èŠå¤©è³‡è¨Šï¼Œè«‹å¾ LINE å°è©±ä¸­é‡æ–°é–‹å•Ÿã€‚");
          showListMessage("æ‰¾ä¸åˆ°èŠå¤© ID", "è«‹å›åˆ° LINE å°è©±ä¸­é‡æ–°é–‹å•Ÿæ­¤åŠŸèƒ½ã€‚");
          return;
        }
        reloadFn = loadTasks;
        loadTasks();
      }).catch(function(err){
        console.error(err);
        setOut("è®€å–ä½¿ç”¨è€…è³‡è¨Šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
        showListMessage("è®€å–å¤±æ•—", "ç„¡æ³•å–å¾—ä½¿ç”¨è€…è³‡è¨Šï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
      });
      return;
    }

    if (!liff.isInClient()){
      setOut("æç¤ºï¼šè«‹å¾ LINE å…§é–‹å•Ÿæ­¤é ï¼Œä»¥ä¾¿ç›´æ¥æŠŠæŒ‡ä»¤é€å›èŠå¤©å®¤ã€‚");
    } else {
      setOut("");
    }
    reloadFn = loadActivities;
    loadActivities();
  }).catch(function(err){
    console.error(err);
    setOut("LIFF åˆå§‹åŒ–å¤±æ•—æˆ– API å–ç”¨å¤±æ•—ã€‚");
    showFetchError(err && err.message);
  });
}

boot();
</script>
</body>
</html>
