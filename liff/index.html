<!-- liff/index.html -->
<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ç¥¨æ•¸åµæ¸¬ LIFF</title>
  <script src="https://static.line-scdn.net/liff/edge/versions/2.23.1/sdk.js"></script>
  <style>
    body { font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Noto Sans TC",sans-serif; margin:16px; }
    .row { display:flex; gap:12px; align-items:center; margin-top:8px; flex-wrap:wrap; }
    .card { border:1px solid #ddd; border-radius:12px; padding:12px; margin:10px 0; }
    .title { font-weight:700; }
    .hint { color:#666; }
    button { padding:8px 12px; border-radius:10px; border:1px solid #ccc; cursor:pointer; background:#fff; }
    button.secondary { background:#f5f5f5; }
    button.danger { background:#ffeaea; border-color:#ffbcbc; }
    input { padding:6px 8px; border-radius:8px; border:1px solid #ccc; width:90px; }
    #out { margin:8px 0; color:#999; }
    .poster { width:100%; max-width:360px; border-radius:10px; margin:12px 0 6px; object-fit:cover; }
    .buttons { gap:10px; }
    .status { margin-top:6px; font-size:0.92em; }
  </style>
</head>
<body>
  <div class="row">
    ç›£çœ‹ç§’æ•¸ï¼š<input id="sec" type="number" min="15" step="1" value="30" />
    <button id="reload">é‡æ–°æ•´ç†æ¸…å–®</button>
  </div>
  <div id="out" class="hint">åˆå§‹åŒ–ä¸­â€¦</div>
  <div id="list"></div>

<script>
/** ====== ä½ çš„è¨­å®šï¼ˆä½¿ç”¨å®Œæ•´ç¶²åŸŸï¼‰ ====== */
var LIFF_ID = "2008066018-EMmpzmKo";  // ä½ çš„ LIFF ID
var API     = "https://ticketsearch-933798663509.asia-east1.run.app/liff/activities"; // â† æ”¹æˆä½ çš„å®Œæ•´ç¶²å€
var MIN_SEC = 15;
var ACT_LIMIT = 30;
/** ===================================== */

function ensureSec(v){
  var n = parseInt(v, 10);
  if (isNaN(n) || n < MIN_SEC) n = MIN_SEC;
  return n;
}

function buildActivitiesUrl(){
  var u;
  try {
    u = new URL(API);
  } catch (e) {
    u = new URL(API, window.location.href);
  }
  u.searchParams.set("onlyConcert", "1");
  if (ACT_LIMIT && !isNaN(ACT_LIMIT)) {
    u.searchParams.set("limit", String(ACT_LIMIT));
  }
  return u.toString();
}

function computeStatusApi(){
  var u;
  try {
    u = new URL(API);
  } catch (e) {
    u = new URL(API, window.location.href);
  }
  var parts = u.pathname.split("/").filter(function(p){ return p; });
  if (parts.length === 0){
    parts = ["liff", "watch_status"];
  } else {
    parts[parts.length - 1] = "watch_status";
  }
  u.pathname = "/" + parts.join("/");
  u.search = "";
  u.hash = "";
  return u.toString();
}

var STATUS_API = computeStatusApi();

function fetchActs(){
  var url = buildActivitiesUrl();
  return fetch(url, { credentials: "include", mode: "cors" }).then(function(res){
    if (!res.ok) throw new Error("HTTP " + res.status);
    return res.json();
  });
}

function fetchWatchStatus(chatId, urls){
  if (!chatId || !Array.isArray(urls) || urls.length === 0) return Promise.resolve({});
  var unique = [];
  var seen = {};
  urls.forEach(function(u){
    if (typeof u !== "string") return;
    var val = u.trim();
    if (!val || seen[val]) return;
    seen[val] = true;
    unique.push(val);
  });
  if (unique.length === 0) return Promise.resolve({});

  return fetch(STATUS_API, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    credentials: "include",
    mode: "cors",
    body: JSON.stringify({ chatId: chatId, urls: unique })
  }).then(function(res){
    if (!res.ok) throw new Error("HTTP " + res.status);
    return res.json();
  }).then(function(body){
    return body && body.results ? body.results : {};
  }).catch(function(err){
    console.error("watch_status error", err);
    return {};
  });
}

function el(tag, cls, html){
  var d = document.createElement(tag);
  if (cls) d.className = cls;
  if (html != null) d.innerHTML = html;
  return d;
}

function resolveChatId(){
  if (!liff.isInClient()) return Promise.resolve(null);
  try {
    var ctx = liff.getContext();
    if (ctx) {
      if (ctx.type === "group" && ctx.groupId) return Promise.resolve(ctx.groupId);
      if (ctx.type === "room" && ctx.roomId) return Promise.resolve(ctx.roomId);
      if (ctx.userId) return Promise.resolve(ctx.userId);
    }
  } catch (e) {
    console.warn("getContext failed", e);
  }
  return liff.getProfile().then(function(p){
    return p && p.userId ? p.userId : null;
  }).catch(function(){ return null; });
}

function render(acts, ctx){
  var elList = document.getElementById("list");
  elList.innerHTML = "";

  if (!Array.isArray(acts) || acts.length === 0){
    elList.appendChild(el("div", "hint", "ç›®å‰æŠ“ä¸åˆ°æ´»å‹•æ¸…å–®ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚"));
    return;
  }

  ctx = ctx || {};
  var statusMap = ctx.statusMap || {};
  var chatId = ctx.chatId || null;

  acts.forEach(function(it, i){
    var title = it.title || ("æ´»å‹• " + (i + 1));
    var url   = (it.url || "").trim();
    var normUrl = url;
    var status = statusMap[normUrl];
    if (!status) {
      status = statusMap[normUrl] = { watching: false, enabled: false, taskId: null };
    }

    var card = el("div", "card", "");
    card.appendChild(el("div", "title", String(i+1).padStart(2,"0") + ". " + title));

    if (it.image){
      var img = el("img", "poster", "");
      img.src = it.image;
      img.alt = title;
      card.appendChild(img);
    }

    var row  = el("div", "row", "");
    var link = el("a", null, "æ´»å‹•é é¢");
    if (url){
      link.href = url;
      link.target = "_blank";
    }else{
      link.className = "hint";
      link.href = "javascript:void(0)";
      link.innerHTML = "ï¼ˆç„¡æœ‰æ•ˆé€£çµï¼‰";
    }
    row.appendChild(link);

    card.appendChild(row);

    var statusLabel = null;
    if (status.taskId){
      var text = status.enabled ? ("ç‹€æ…‹ï¼šç›£çœ‹ä¸­ï½œä»»å‹™ " + status.taskId) : ("ç‹€æ…‹ï¼šä»»å‹™ " + status.taskId + " å·²åœç”¨");
      statusLabel = el("div", "hint status", text);
      card.appendChild(statusLabel);
    } else if (status.found){
      statusLabel = el("div", "hint status", "ç‹€æ…‹ï¼šæ­¤æ´»å‹•å·²å»ºç«‹ä»»å‹™ä½†ç›®å‰æœªå•Ÿç”¨");
      card.appendChild(statusLabel);
    }

    var buttons = el("div", "row buttons", "");

    var btnWatch = el("button", null, "âœ… ç›£çœ‹");
    btnWatch.onclick = function(){
      if (!url){ alert("æ­¤æ´»å‹•æ²’æœ‰å¯ç”¨çš„ URLï¼Œç„¡æ³•ç›£çœ‹ã€‚"); return; }
      var s = ensureSec(document.getElementById("sec").value);
      if (!liff.isInClient()){
        alert("æç¤ºï¼šç›®å‰ä¸æ˜¯å¾ LINE å…§é–‹å•Ÿï¼Œå°‡åƒ…é–‹å•Ÿæ´»å‹•é é¢ã€‚");
        window.open(url, "_blank");
        return;
      }
      var text = "/watch " + url + " " + s;
      var original = btnWatch.textContent;
      btnWatch.disabled = true; btnWatch.textContent = "é€å‡ºä¸­â€¦";
      liff.sendMessages([{ type:"text", text:text }]).then(function(){
        alert("å·²é€å‡ºç›£çœ‹æŒ‡ä»¤åˆ°èŠå¤©å®¤ï¼");
        if (statusLabel){
          statusLabel.textContent = "ç‹€æ…‹ï¼šå·²é€å‡ºç›£çœ‹æŒ‡ä»¤ï¼Œè«‹ç•™æ„èŠå¤©å®¤å›è¦†ä»»å‹™ä»£ç¢¼ã€‚";
        } else {
          statusLabel = el("div", "hint status", "ç‹€æ…‹ï¼šå·²é€å‡ºç›£çœ‹æŒ‡ä»¤ï¼Œè«‹ç•™æ„èŠå¤©å®¤å›è¦†ä»»å‹™ä»£ç¢¼ã€‚");
          card.appendChild(statusLabel);
        }
        status.enabled = true;
        status.watching = true;
        return liff.openWindow({ url: url, external: false });
      }).catch(function(e){
        alert("é€è¨Šæ¯æˆ–é–‹å•Ÿé é¢å¤±æ•—ï¼š" + e);
        console.error(e);
      }).finally(function(){
        btnWatch.disabled = false;
        btnWatch.textContent = original;
      });
    };
    buttons.appendChild(btnWatch);

    var btnStop = el("button", "danger", "â¹ åœæ­¢ç›£çœ‹");
    btnStop.onclick = function(){
      if (!url){ alert("æ­¤æ´»å‹•æ²’æœ‰å¯ç”¨çš„ URLã€‚"); return; }
      if (!liff.isInClient()){
        alert("è«‹æ–¼ LINE å…§ä½¿ç”¨åœæ­¢ç›£çœ‹åŠŸèƒ½ã€‚");
        return;
      }
      if (!chatId){
        alert("æœªå–å¾—èŠå¤©å®¤è­˜åˆ¥ï¼Œè«‹é‡æ–°é–‹å•Ÿ LIFF å¾Œå†è©¦ä¸€æ¬¡ã€‚");
        return;
      }
      if (!status.taskId || !status.enabled){
        alert("æ­¤æ´»å‹•ç„¡ç›£çœ‹");
        return;
      }
      var original = btnStop.textContent;
      btnStop.disabled = true; btnStop.textContent = "é€å‡ºä¸­â€¦";
      liff.sendMessages([{ type:"text", text:"/unwatch " + status.taskId }]).then(function(){
        alert("å·²é€å‡ºåœæ­¢ç›£çœ‹æŒ‡ä»¤ï¼");
        status.enabled = false;
        status.watching = false;
        if (statusLabel){
          statusLabel.textContent = "ç‹€æ…‹ï¼šå·²é€å‡ºåœæ­¢ç›£çœ‹æŒ‡ä»¤ï¼Œè«‹ç•™æ„èŠå¤©å®¤å›è¦†ã€‚";
        } else {
          statusLabel = el("div", "hint status", "ç‹€æ…‹ï¼šå·²é€å‡ºåœæ­¢ç›£çœ‹æŒ‡ä»¤ï¼Œè«‹ç•™æ„èŠå¤©å®¤å›è¦†ã€‚");
          card.appendChild(statusLabel);
        }
      }).catch(function(e){
        alert("é€å‡ºåœæ­¢ç›£çœ‹å¤±æ•—ï¼š" + e);
        console.error(e);
      }).finally(function(){
        btnStop.disabled = false;
        btnStop.textContent = original;
      });
    };
    buttons.appendChild(btnStop);

    var btnCheck = el("button", "secondary", "ğŸ‘€ å¿«é€ŸæŸ¥çœ‹");
    btnCheck.onclick = function(){
      if (!url){ alert("æ­¤æ´»å‹•æ²’æœ‰å¯ç”¨çš„ URLã€‚"); return; }
      if (!liff.isInClient()){
        alert("æç¤ºï¼šç›®å‰ä¸æ˜¯å¾ LINE å…§é–‹å•Ÿï¼Œå°‡ç›´æ¥é–‹å•Ÿæ´»å‹•é é¢ã€‚");
        window.open(url, "_blank");
        return;
      }
      var original = btnCheck.textContent;
      btnCheck.disabled = true; btnCheck.textContent = "é€å‡ºä¸­â€¦";
      liff.sendMessages([{ type:"text", text:"/check " + url }]).then(function(){
        alert("å·²é€å‡ºå¿«é€ŸæŸ¥çœ‹æŒ‡ä»¤ï¼");
        if (statusLabel){
          statusLabel.textContent = "ç‹€æ…‹ï¼šå·²é€å‡ºå¿«é€ŸæŸ¥çœ‹æŒ‡ä»¤ï¼Œè«‹æ–¼èŠå¤©å®¤æŸ¥çœ‹å›è¦†ã€‚";
        } else {
          statusLabel = el("div", "hint status", "ç‹€æ…‹ï¼šå·²é€å‡ºå¿«é€ŸæŸ¥çœ‹æŒ‡ä»¤ï¼Œè«‹æ–¼èŠå¤©å®¤æŸ¥çœ‹å›è¦†ã€‚");
          card.appendChild(statusLabel);
        }
      }).catch(function(e){
        alert("é€å‡ºå¿«é€ŸæŸ¥çœ‹å¤±æ•—ï¼š" + e);
        console.error(e);
      }).finally(function(){
        btnCheck.disabled = false;
        btnCheck.textContent = original;
      });
    };
    buttons.appendChild(btnCheck);

    card.appendChild(buttons);
    elList.appendChild(card);
  });
}

function showApiError(){
  var elList = document.getElementById("list");
  elList.innerHTML =
    "<div class='card'><div class='title'>è®€å–æ´»å‹•æ¸…å–®å¤±æ•—</div>" +
    "<div class='hint'>è«‹ç¢ºèªå¾Œç«¯ " + API + " æ˜¯å¦ 200 OKï¼Œä¸¦é–‹å•Ÿ CORSã€‚</div></div>";
}

function boot(){
  var out = document.getElementById("out");
  out.textContent = "LIFF åˆå§‹åŒ–ä¸­â€¦";

  var activities = [];

  liff.init({ liffId: LIFF_ID }).then(function(){
    var inClient = liff.isInClient();
    if (!inClient){
      out.textContent = "æç¤ºï¼šè«‹å¾ LINE å…§é–‹å•Ÿæ­¤é ï¼Œä»¥ä¾¿ç›´æ¥æŠŠæŒ‡ä»¤é€å›èŠå¤©å®¤ã€‚";
    }else{
      out.textContent = "";
    }

    return fetchActs().then(function(acts){
      activities = Array.isArray(acts) ? acts : [];
      if (!inClient){
        render(activities, { statusMap: {} });
        return;
      }
      return resolveChatId().then(function(chatId){
        return fetchWatchStatus(chatId, activities.map(function(it){ return it && it.url ? it.url : ""; })).then(function(status){
          render(activities, { statusMap: status, chatId: chatId });
        });
      });
    }).catch(function(e){
      console.error(e); showApiError();
    });
  }).catch(function(e){
    console.error(e);
    out.textContent = "LIFF åˆå§‹åŒ–å¤±æ•—æˆ– API å–ç”¨å¤±æ•—ã€‚";
    showApiError();
  });
}

document.getElementById("reload").onclick = boot;
boot();
</script>
</body>
</html>