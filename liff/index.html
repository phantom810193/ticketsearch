<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>選活動監看</title>
  <script src="https://static.line-scdn.net/liff/edge/versions/2.23.1/sdk.js"></script>
  <style>
    body{font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC",sans-serif;margin:16px}
    .row{display:flex;gap:12px;align-items:center;margin:8px 0}
    .grid{display:block}
    .card{border:1px solid #eee;border-radius:12px;padding:12px;margin:10px 0}
    .title{font-weight:700;margin-bottom:6px}
    button{padding:8px 12px;border-radius:10px;border:1px solid #ddd;cursor:pointer}
    .hint{color:#888;font-size:14px;margin-top:8px}
    input[type=number]{width:90px;padding:6px 8px}
    a{color:#0b73ff;text-decoration:none}
  </style>
</head>
<body>
  <h2>選活動監看</h2>

  <div class="row">
    <label>每次檢查秒數：</label>
    <input id="sec" type="number" min="15" step="5" value="60" />
    <button id="reload">重新載入</button>
  </div>
  <div id="out" class="hint"></div>

  <div id="list" class="grid"></div>

  <script>
    // === 換成你的資料 ===
    var LIFF_ID = "2008066018-EMmpzmKo";
    var API = "/liff/activities";
    var MIN_SEC = 15;

    function ensureSec(v) {
      var n = parseInt(v, 10);
      if (isNaN(n) || n < MIN_SEC) n = MIN_SEC;
      return n;
    }

    function fetchActs() {
      return fetch(API, { credentials: "include" }).then(function(res) {
        if (!res.ok) throw new Error("HTTP " + res.status);
        return res.json();
      });
    }

    function el(tag, cls, html) {
      var d = document.createElement(tag);
      if (cls) d.className = cls;
      if (html != null) d.innerHTML = html;
      return d;
    }

    function render(acts) {
      var elList = document.getElementById("list");
      elList.innerHTML = "";
      if (!Array.isArray(acts) || acts.length === 0) {
        elList.appendChild(el("div", "hint", "目前抓不到活動清單，請稍後再試。"));
        return;
      }
      var sec = ensureSec(document.getElementById("sec").value);
      acts.forEach(function(it, i) {
        var title = (it.title || ("活動 " + (i + 1)));
        var url = it.url;

        var card = el("div", "card", "");
        card.appendChild(el("div", "title", (String(i+1).padStart(2,"0")) + ". " + title));

        var row = el("div", "row", "");
        var link = el("a", null, "活動頁面");
        link.href = url;
        link.target = "_blank";
        row.appendChild(link);

        var btn = el("button", null, "✅ 監看");
        btn.onclick = function() {
          var s = ensureSec(document.getElementById("sec").value);
          var text = "/watch " + url + " " + s;
          liff.sendMessages([{ type: "text", text: text }]).then(function() {
            alert("已送出監看指令到聊天室！");
          }).catch(function(e) {
            alert("送訊息失敗：" + e);
          });
        };
        row.appendChild(btn);

        card.appendChild(row);
        elList.appendChild(card);
      });
    }

    function boot() {
      var out = document.getElementById("out");
      liff.init({ liffId: LIFF_ID }).then(function() {
        if (!liff.isInClient()) {
          out.textContent = "提示：請從 LINE 內開啟此頁以便直接把指令送回聊天室。";
        } else {
          out.textContent = "";
        }
        return fetchActs().then(render).catch(function(e){
          document.getElementById("list").innerHTML =
            "<div class='hint'>讀取活動清單失敗，請確認後端 /liff/activities 是否可用。</div>";
          console.error(e);
        });
      }).catch(function(e) {
        out.textContent = "LIFF 初始化失敗，請確認 LIFF ID 與 Endpoint URL 設定。";
        console.error(e);
      });
    }

    document.getElementById("reload").onclick = boot;
    boot();
  </script>
</body>
</html>